name: Issue Labeler

on:
    issues:
        types: [opened, edited]

jobs:
    triage:
        runs-on: ubuntu-latest
        steps:
            - name: Apply labels based on title and body
              uses: actions/github-script@v7
              with:
                script: |
                    const title = context.payload.issue.title.toLowerCase();
                    const body = context.payload.issue.body ? context.payload.issue.body.toLowerCase() : "";
                    const existingLabels = context.payload.issue.labels.map(label => label.name);

                    const labels = [];

                    if (/ci/.test(title) || /ci/.test(body)) {
                      labels.push("ci");
                    }
                    if (/bug/.test(title) || /error/.test(body) || /failed/.test(body)) {
                      labels.push("bug");
                    }
                    if (/zed/.test(title) || /zed/.test(body)) {
                      labels.push("zed-sdk");
                    }
                    if (/lart_msgs/.test(title) || /lart_msgs/.test(body)) {
                      labels.push("dependencies");
                    }
                    if (/perception/.test(title) || /perception/.test(body)) {
                      labels.push("perception");
                    }
                    if (/planner/.test(title) || /planner/.test(body)) {
                      labels.push("planner");
                    }
                    if (/controller/.test(title) || /controller/.test(body)) {
                      labels.push("controller");
                    }

                    // Filter out labels that already exist
                    const newLabels = labels.filter(label => !existingLabels.includes(label));

                    // If no new labels found, add "needs-triage"
                    if (newLabels.length === 0) {
                      newLabels.push("needs-triage");
                    }

                    if (newLabels.length > 0) {
                      await github.rest.issues.addLabels({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        labels: newLabels
                      });
                    }